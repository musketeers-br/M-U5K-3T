Class tests.dc.Simul Extends %RegisteredObject
{

/// Roda os 3 cen√°rios de teste no Terminal
/// Do ##class(Test.Debug).Run()
ClassMethod Run()
{
    Write !, "=== INICIANDO BATERIA DE TESTES DE DEPLOY ===",!
    
    // 1. Teste de Vit√≥ria (C√≥digo V√°lido)
    Write !, "üì° TIPO 1: MISS√ÉO PADR√ÉO (Tentativa de Vit√≥ria)",!
    Do ..SimulateDeploy("VALID")
    
    // 2. Teste de Viola√ß√£o (Hacker)
    Write !, "üíÄ TIPO 2: VIOLA√á√ÉO DE SEGURAN√áA (Hacker)",!
    Do ..SimulateDeploy("HACK")
    
    // 3. Teste de Quebra (Erro de Runtime)
    Write !, "üí• TIPO 3: FALHA CR√çTICA (Erro de Sintaxe/Runtime)",!
    Do ..SimulateDeploy("CRASH")
    
    Write !, "=== TESTES CONCLU√çDOS ===",!
}

ClassMethod SimulateDeploy(type As %String)
{
    Set user = "cmd-henry"
    Set mission = "M1"
    Set code = ""
    
    // --- DEFINI√á√ÉO DOS CEN√ÅRIOS ---
    
    // CEN√ÅRIO 1: C√≥digo V√°lido (Anda e Vira se bater)
    If type = "VALID" {
        Set code = " // L√≥gica Simples de Rover" _
                " Set sensors = context.rover.sensors" _
                " If sensors.front = ""OBSTACLE"" { " _
                "    Do context.action.%Set(""turn"", ""right"") " _
                " } Else { " _
                "    Do context.action.%Set(""move"", """") " _
                " }"
    }
    
    // CEN√ÅRIO 2: Hacker (Tenta acessar o Sistema)
    If type = "HACK" {
        Set code = " Do $System.OBJ.ShowFlags()" // PROIBIDO!
    }
    
    // CEN√ÅRIO 3: Crash (Divis√£o por Zero)
    If type = "CRASH" {
        Set code = " Set x = 1 / 0 " // KABOOM!
    }
    
    // --- MONTAGEM DO PAYLOAD ---
    Set payload = {}
    Set payload.username = user
    Set payload.missionId = mission
    Set payload.code = code
    Set payloadStr = payload.%ToJSON()
    
    // --- EXECU√á√ÉO (Simulando o WorkQueue) ---
    Set ticket = $System.Util.CreateGUID()
    Write "üé´ Ticket Gerado: ", ticket, !
    
    // Chama o Worker DIRETAMENTE (Sem WorkQueueMgr para ver o log aqui mesmo)
    Set tSC = ##class(dc.mu5k3t.model.Player).MissionDeployWorker(payloadStr, ticket)
    
    If $$$ISERR(tSC) {
        Write "‚ùå ERRO NO WORKER: ", $System.Status.GetErrorText(tSC), !
        Quit
    }
    
    // --- LEITURA DO BUFFER ---
    Set jsonResult = ""
    Set errorMsg = ""
    
    // L√™ o resultado da "Caixa de Correio" segura
    Set tSCRead = ##class(dc.mu5k3t.storage.WorkBuffer).ReadAndDestroy(ticket, .jsonResult, .errorMsg)
    
    If $$$ISERR(tSCRead) {
        Write "‚ùå ERRO AO LER BUFFER: ", $System.Status.GetErrorText(tSCRead), !
        Quit
    }
    
    If errorMsg'="" {
            Write "‚ö†Ô∏è WORKER REPORTOU ERRO: ", errorMsg, !
            // Se for erro de m√©todo inexistente, mostramos detalhes
            If jsonResult'="" Write "   DETALHES: ", jsonResult, !
        } Else {
            Write "‚úÖ SUCESSO! JSON RETORNADO:", !
            Set obj = {}.%FromJSON(jsonResult)
            Write "   STATUS: ", obj.status, !
            
            If obj.finalScore'="" Write "   SCORE:  ", obj.finalScore, !
            
            // CORRE√á√ÉO AQUI: Verificar se timeline existe antes de acessar %Size
            If $IsObject(obj.timeline) {
                Write "   STEPS:  ", obj.timeline.%Size(), !
            } Else {
                Write "   STEPS:  (N/A)", !
            }
            
            If obj.error'="" Write "   ERRO LOGICO: ", obj.error, !
            If obj.message'="" Write "   MENSAGEM: ", obj.message, !
        }
        Write "--------------------------------------------------",!
}

}
