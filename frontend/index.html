<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Three.js Starter</title>
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <div id="loader" class="loader">
    <div class="loader-content">LOADING ASSETS...</div>
  </div>

  <!-- Landing View -->
  <div id="landing-view" class="view cinematic-view">
    <div class="cinematic-content">
      <h1 class="glitch-text">M-U5K-3T // ORBITAL UPLINK</h1>
      <p class="mission-statement">
        Command a remote rover using InterSystems ObjectScript.<br />
        Your mission: Extract minerals from hostile exoplanets.<br />
        Optimize your code for high-latency bandwidth, manage fuel efficiency,<br />
        and climb the global leaderboard.
      </p>
      <div class="login-form">
        <input type="text" id="username-input" placeholder="Enter your dc profile username" autocomplete="off"
          aria-describedby="username-help" />
        <small id="username-help" class="form-text text-muted">
          Find it in your profile URL: community.intersystems.com/user/<strong>your-username</strong>
        </small>
        <button id="initialize-uplink-btn" class="btn blue large">INITIALIZE UPLINK</button>
      </div>
      <div id="landing-status" class="login-status hidden"></div>
    </div>
  </div>

  <!-- Tutorial View -->
  <div id="tutorial-view" class="view overlay-view hidden">
    <div class="modal-content">
      <h2>MISSION BRIEFING</h2>
      <div id="tutorial-slides" class="slides-container">
        <!-- Slide 1: Story -->
        <div class="slide active">
          <h3>The High-Latency Link</h3>
          <p>Due to your distance from the target planet, direct control is impossible. You must program the rover's
            autonomous logic using InterSystems ObjectScript.</p>
        </div>
        <!-- Slide 2: Objective -->
        <div class="slide">
          <h3>Core Objectives</h3>
          <p>Scout for minerals, avoid obstacles, and survive hazardous zones. Some missions require you to return to
            the landing base (0,0) before fuel runs out.</p>
        </div>
        <!-- Slide 3: Controls -->
        <div class="slide">
          <h3>Flight Modes</h3>
          <p><b>SIMULATION:</b> Rapidly test your code in a virtual environment. <br><b>DEPLOY:</b> Send your code to
            the actual rover and watch the results.</p>
        </div>
      </div>
      <div class="modal-footer">
        <div class="tutorial-nav">
          <button id="prev-slide-btn" class="btn small hidden">PREVIOUS</button>
          <button id="next-slide-btn" class="btn small cyan">NEXT STEP</button>
        </div>
        <div class="tutorial-finish hidden">
          <label class="checkbox-container">
            <input type="checkbox" id="skip-tutorial-check">
            <span class="checkmark"></span>
            Don't show this briefing again
          </label>
          <button id="enter-control-btn" class="btn cyan">ENTER MISSION CONTROL</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mission Hub -->
  <div id="mission-hub" class="view cinematic-view hidden">
    <div class="hub-header">
      <h1>OPERATIONAL DASHBOARD</h1>
      <div id="user-stats-pill" class="stats-pill">
        <span id="display-username">PILOT</span> | <span id="total-score">Score: 0</span> | <span id="pilot-rank">Rank:
          Cadet</span>
      </div>
    </div>
    <div id="mission-list" class="mission-grid">
      <!-- Dynamic Mission Cards go here -->
    </div>
    <div class="hub-footer">
      <button id="logout-btn" class="btn red small">LOGOUT</button>
    </div>
  </div>

  <!-- Game View -->
  <div id="game-view" class="view hidden">
    <button id="back-to-hub-btn" class="btn-back">« BACK TO DASHBOARD</button>

    <div id="hud" class="hud">
      Fuel: <span id="fuel-display">100</span> | HP: <span id="hp-display" style="color:#0f0">100%</span> | Score: <span
        id="score-display">0</span>
      <span id="toxic-warning" class="toxic-warning hidden">⚠️ TOXIC WARNING</span>
    </div>

    <div id="terminal" class="terminal">
      <button id="toggle-terminal" class="toggle-btn">→</button>
      <div class="terminal-header">
        MISSION CONTROL
        <button id="btn-export" title="Download Code"
          style="background:none; border:none; color:white; cursor:pointer; font-size: 18px; opacity: 0.7; transition: opacity 0.2s;">⬇️</button>
      </div>
      <textarea id="code-editor" spellcheck="false">
ClassMethod OnTick(context As %DynamicObject)
{
    Set rover = context.%Get("rover")
    Set memory = context.%Get("memory")
    Set step = memory.%Get("step")
    If step = "" { Set step = 0 }
    
    // Mission Pattern: 5 moves per side
    // Tip: The mission runs until Fuel runs out or HP hits 0.
    If step < 5 {
        Do context.%Set("output", {"action": "MOVE", "param": "north"})
    } ElseIf step = 5 {
        Do context.%Set("output", {"action": "TURN", "param": "east"})
    } ElseIf step < 11 {
        Do context.%Set("output", {"action": "MOVE", "param": "east"})
    } ElseIf step = 11 {
        Do context.%Set("output", {"action": "TURN", "param": "south"})
    } ElseIf step < 17 {
        Do context.%Set("output", {"action": "MOVE", "param": "south"})
    } ElseIf step = 17 {
        Do context.%Set("output", {"action": "TURN", "param": "west"})
    } ElseIf step < 23 {
        Do context.%Set("output", {"action": "MOVE", "param": "west"})
    } ElseIf step = 23 {
        Do context.%Set("output", {"action": "TURN", "param": "north"})
    }
    
    Do memory.%Set("step", step + 1)
}
        </textarea>
      <div id="mission-info" class="mission-info">

        <div id="mission-briefing" class="mission-briefing highlight">
          Uplink Active...
        </div>
      </div>
      <div class="controls">
        <button id="execute-test-btn" class="btn blue">EXECUTE TEST</button>
        <button id="reset-btn" class="btn red">RESET</button>
        <button id="deploy-orbit-btn" class="btn orange">DEPLOY TO ORBIT</button>
      </div>
      <div id="logs" class="logs">
        <div class="log-entry system">System initialized.</div>
      </div>
    </div>

    <div id="transmission-overlay" class="transmission-overlay hidden">
      <div class="transmission-content">
        <div class="pulse-light"></div>
        <p>Transmitting to M-USK-3T...</p>
      </div>
    </div>

    <div id="game-over-screen" class="game-over-overlay hidden">
      <div class="game-over-content">
        <div class="game-over-title">⚠️ MISSION FAILED ⚠️</div>
        <div id="game-over-reason" class="game-over-reason"></div>
        <button id="retry-btn" class="btn red large">REBOOT ROVER</button>
      </div>
    </div>

    <div id="victory-screen" class="victory-overlay hidden">
      <div class="victory-content">
        <div class="victory-title">★ MISSION ACCOMPLISHED ★</div>
        <div class="victory-stats">
          <div>Minerals: <span id="v-minerals">0</span></div>
          <div>Fuel Left: <span id="v-fuel">0</span></div>
          <div>Efficiency: <span id="v-efficiency">0%</span></div>
        </div>
        <button id="v-continue-btn" class="btn gold large">ACKNOWLEDGE</button>
      </div>
    </div>
  </div>

  <script type="module" src="/main.js"></script>
</body>

</html>